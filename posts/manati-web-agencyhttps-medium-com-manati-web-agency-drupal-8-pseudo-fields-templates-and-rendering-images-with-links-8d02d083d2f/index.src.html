<html><body><figure><img alt="" src="https://cdn-images-1.medium.com/max/800/1*i9Lxf4RqvuJbLRf426cb0g.png"><figcaption>Illustration by <a href="https://medium.com/u/685ec9b9459c">Lucy Sánchez</a></figcaption></figure><p><em>Lea este artículo en español: </em><strong><em>Drupal 8</em>:</strong> <a href="https://medium.com/p/40870e35970e"><strong>Pseudocampos, templates y render de imágenes con links.</strong></a></p><p>A few days ago I started the development of a new Drupal 8 site. This site has come with a large set of interesting challenges because a lot of the required functionality is still not easy to implement. As of this moment, there are a lot of contrib modules that are in development, one of them is <a href="https://www.drupal.org/project/group"><em>group</em></a>.</p><p>Our client requires that every authenticated user can see the groups it belongs to directly from its profile. This feature is required to be done in such a way that you can see the group’s logo, and the logo has to be linked to that group page on the site. I researched alternatives with <em>views</em> and other contrib modules, but it didn’t bear fruit.</p><p>I opted for the custom approach: to create a pseudo field for the users. Such field would use a template in order to print the groups the user belongs to.</p><p><strong>Shoulders to the wheel!</strong></p><p>First we need to create a pseudo field. Let’s remember that pseudo fields are elements that, just like fields, we can manage from the admin interface of each entity, but the difference lies in that the element has only one function: to display information. Contrary to that, a field will store and show information entered by the users.</p><p>In Drupal 8 -like Drupal 7- we need to use 2 hooks to create our pseudo field for an entity: <em>hook_entity_extra_field_info()</em> and<em> hook_[ENTITY NAME]_view().</em></p><p><strong>hook_entity_extra_field_info().</strong></p><p>It tells the entity that there will be a new element available to display. For our case, we’ll implement it like so:</p><pre>/**<br> * Implements hook_entity_extra_field_info().<br> */<br>function my_module_entity_extra_field_info() {<br>  $extra = [];<br>  $extra['user']['user']['display']['my_mudule_active_subsites'] = array(<br>    'label' =&gt; new TranslatableMarkup('Active subsites'),<br>    'description' =&gt; new TranslatableMarkup('Show the current subscribed sites by one user'),<br>  );<br>  return $extra;<br>}</pre><p><strong>hook_[ENTITY NAME]_view()</strong></p><p>In this case, we’re interested in using <em>hook_user_view()</em> because we’re working with the user type entity. <em>hook_[ENTITY NAME]_view() </em>basically handles the display of each one of the elements of an entity. In this case, we’ll use it to format our pseudo field <em>my_mudule_active_subsites</em>.</p><p>For Drupal 8, the implementation of this hook varies a bit in the parameters it receives, we can find more documentation here:</p><p><a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Entity%21entity.api.php/function/hook_entity_view/8.2.x">https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Entity%21entity.api.php/function/hook_entity_view/8.2.x</a></p><pre>/**<br> * Implements hook_user_view().<br> */<br>function my_module_view(array &amp;$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode, $langcode) {<br>  if ($view_mode === 'full') {<br>    if ($display-&gt;getComponent('my_module_active_subsites')) {<br>      $groups = my_module_user_current_user_groups($entity);<br>      $groups_to_render = my_module_render_groups_images($groups);<br>      $build['my_module_user_active_subsites'] = [<br>        '#theme' =&gt; 'my_module_active_subsites',<br>        '#groups' =&gt; $groups_to_render,<br>      ];<br>    }<br>  }<br>}</pre><p>Like the example, we’re using the variable build that we get from the reference, to assign the value to show with our pseudo field. Notice that we created a new index inside the build array, which is a render array. Inside our index we’ll use #theme to indicate that we’re going to use a template, which we’ll define further down the road, and we’ll also use a variable called #groups, which is a variable inside our template.</p><p>Now, an important detail: like you can see in our example, we use 2 functions to obtain both the the groups of the user and the preprocessed data ready to be printed by Drupal. The function <em>my_module_user_current_user_groups() </em>basically returns an array of the entity type group, in which we wont delve. On the contrary, we’ll see the details of <em>my_module_render_groups_images()</em>.</p><h4>my_module_render_groups_images()</h4><p>This function was born because of our need to wrap the images in a link, specifically a link to the entity type group. We’ll solve that this way:</p><pre>/**<br> * Helper function to render the images with a specific image style.<br> *<br> * @param array $groups<br> *   The entity groups with the images to render.<br> */<br>function my_module_render_groups_images(array $groups) {<br>  $groups_to_render = [];<br>  foreach ($groups as $group) {<br>    $group_item = new Stdclass();<br>    $image_id = $group-&gt;field_site_logo-&gt;target_id;<br>    if (!empty($image_id)) {<br>      $image_render_array = [<br>        '#theme' =&gt; 'image_style',<br>        '#width' =&gt; $group-&gt;field_site_logo-&gt;width,<br>        '#height' =&gt; $group-&gt;field_site_logo-&gt;height,<br>        '#style_name' =&gt; 'site_logo_user_profile',<br>        '#uri' =&gt; $group-&gt;field_site_logo-&gt;entity-&gt;uri-&gt;value,<br>      ];<br>      $renderer = \Drupal::service('renderer');<br>      $renderer-&gt;addCacheableDependency($image_render_array, $group-&gt;field_site_logo-&gt;entity);<br>      $rendered_image = $renderer-&gt;render($image_render_array);<br>      $link_render_array = [<br>        '#type' =&gt; 'link',<br>        '#url' =&gt; Url::fromUri('entity:group/' . $group-&gt;id()),<br>        '#title' =&gt; $rendered_image,<br>      ];<br>      $group_item-&gt;logo = $link_render_array;<br>    }<br>    $groups_to_render[] = $group_item;<br>  }<br>  return $groups_to_render;<br>}</pre><p>As you can see in the example, what we do to print our image with a link is: first, prepare a render array to use the <em>image_style</em> template. After that, we use the service <em>renderer</em> from Drupal 8 (instead of Drupal_render from Drupal 7) to obtain an render type object, which will be assigned as a value for the <em>title</em> of our link.</p><p><strong>Defining our twig template</strong></p><p>Like Drupal 7, if we want to use our own templates inside a module, we need to define it, that is, make Drupal aware that such template exists. For that we’ll use <em>hook_theme()</em>.</p><pre>/**<br> * Implements hook_theme().<br> */<br>function my_module_user_theme($existing, $type, $theme, $path) {<br>  return [<br>    'my_module_user_active_subsites' =&gt; [<br>      'variables' =&gt; [<br>        'groups' =&gt; '',<br>      ],<br>    ],<br>  ];<br>}</pre><p><strong>Creating our template</strong></p><p>For our final step, we’ll proceed to create our twig template. In order to be recognized, our templates have to be placed in a specific location, with a specific naming convention.</p><p>Our templates have to be inside the folder called “templates” in the root of our module and like as I mentioned, have to follow the naming convention: template-name.html.twig. We’ll create the file <em>my-module-active-subsites.html.twig</em>.</p><p>This template will handle the format and will print the images belonging to our groups:</p><pre>{#<br>/**<br> * @file<br> * Template file my_module_active_subsites field<br> */<br>#}</pre><pre>&lt;div class="container user-groups-container"&gt;<br>   {% if groups is not empty %}<br>     {% for group in groups %}<br>        &lt;div class="container user-groups-element" &gt;<br>          {{ group.logo }}<br>        &lt;/div&gt;<br>     {% endfor %}<br>   {% endif %}<br>&lt;/div&gt;</pre><p>As you can see, Twig is very different from what we know before with PHP templates, but this does not mean is complicated. In my case, I used this documentation: <a href="https://www.drupal.org/docs/8/theming/twig/comparison-of-phptemplate-and-twig-theming-paradigms">https://www.drupal.org/docs/8/theming/twig/comparison-of-phptemplate-and-twig-theming-paradigms</a>, which is a comparative between what we used to do in PHP template and how we do it with Twig.</p><p>Pseudo fields in Drupal 8 -like in Drupal 7- are still a great resource that allows flexibility in the display of our entities. If we add templates in the mix, we can comply with any display requirement for our content. Just be aware that it depends on the type of display we need to use for our content.</p><p>Happy coding!</p><p><a href="https://www.estudiomanati.com"><strong><em>Manatí</em></strong></a><strong><em> is a web consultancy firm from Costa Rica</em></strong><em>, where we make websites strategically designed to help organization achieve goals.</em></p><p><em>Don’t miss out on projects, news and ideas from </em><a href="https://www.estudiomanati.com"><em>Manatí</em></a><em>. Learn about </em><a href="https://www.estudiomanati.com/what-we-do.html"><em>what we do</em></a><em>, follow us on </em><a href="https://medium.com/manati-web-agency"><strong><em>medium</em></strong></a><em>, </em><a href="https://twitter.com/estudiomanati"><strong><em>twitter</em></strong></a><em> and </em><a href="https://twitter.com/estudiomanati"><strong><em>facebook</em></strong></a><em>.</em></p><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=8d02d083d2f" width="1" height="1"><hr><p><a href="https://medium.com/manati-web-agency/https-medium-com-manati-web-agency-drupal-8-pseudo-fields-templates-and-rendering-images-with-links-8d02d083d2f">Drupal 8: Pseudo fields, templates and rendering images with links.</a> was originally published in <a href="https://medium.com/manati-web-agency">MANATI | Agencia Web</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p></body></html>