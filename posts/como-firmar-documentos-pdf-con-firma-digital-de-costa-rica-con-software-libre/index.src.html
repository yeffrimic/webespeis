<html><body><p>La <a href="http://www.mifirmadigital.go.cr/wp-content/uploads/2016/03/DCFD-Poli%CC%81tica-de-Formato-Oficial-v1.0.pdf">Política de Formatos Oficiales de los Documentos Electrónicos Firmados Digitalmente</a> de Costa Rica especifica el tipo de documentos y su formato de firma digital. En el caso de PDF se utiliza un estándar especificado en Europa para firma digital avanzada (AdES) y en el caso de los PDF se llama PAdES. En el documento oficial enlazado previamente se muestra que tiene que soportar PAdES-LTV (permite la validación de forma longeva) y sugiere que se use el perfil Baseline. El asunto es que no hay mucho software libre en el mercado que permita la firma digital avanzada en PDF, sin embargo la propia Comisión Europea tiene un proyecto para ello (Digital Signature Services), que es un conjunto de librerías y herramientas en Java que permiten trabajar con firma digital con los estándares europeos, incluyendo soporte para PDF.</p>
<p>Hasta no hace mucho tiempo, una de las pocas implementaciones libres para trabajar con firma digital avanzada en PDF era iText, sin embargo este proyecto cambió de licencia y las condiciones de uso contradecían la propia licencia, además de presuntas incompatibilidades en contribuciones del código por parte de terceros que la hacían incompatible con la nueva licencia. Afortunadamente, el proyecto DSS (usando Apache PDFBox como alternativa a iText) permite firmar documentos PDF cumpliendo con la política de formatos oficiales nacional.</p>
<h2>Instalación en GNU/Linux</h2>
<p>Existe un firmador en formato independiente que funciona en el escritorio. Se puede descargar <a href="https://joinup.ec.europa.eu/sd-dss/webapp-demo/downloads/dss-app.zip">DSS standalone app package 5.0</a> (este es el más reciente en el momento de escribir esta entrada de blog).</p>
<p>Una vez descargado, descomprimir el tarball, contendrá dss-app.jar y un par de scripts para lanzar el jar de forma sencilla. El firmador que hay dentro del jar utiliza por defecto un servidor TSA europeo, para cambiarlo habrá que modificar un fichero que hay dentro del jar en la ruta spring/applicationContext.xml y buscar el texto: <code>http://tsa.belgium.be/connect</code> para reemplazarlo por el siguiente: <code>http://tsa.sinpe.fi.cr/tsahttp/</code> y guardarlo modificado con este cambio dentro del archivo jar (un archivo jar es un archivo zip realmente).</p>
<p>Para poder ejecutar este jar en GNU/Linux se necesita el entorno JRE de OpenJDK 8 y además OpenJFX 8 (JavaFX). En Ubuntu se puede instalar con <code>sudo apt install openjfx</code> y en Fedora mediante un repositorio COPR de terceros con <code>sudo dnf copr enable lenticularis/AVRConfig</code> y luego <code>sudo dnf install openjfx</code>.</p>
<p>Una vez instaladas las dependencias de Java, se puede ejecutar desde la terminal en la carpeta donde se haya descomprimido con <code>sh dss-run.sh</code> o bien con <code>java -jar dss-app.jar</code>.</p>
<p>Aparecerá una ventana como la siguiente:<br>
<img class="alignnone size-medium wp-image-63" src="https://fran.cr/wp-content/uploads/2016/11/Captura-de-pantalla-de-2016-11-07-14-57-51.png" alt="Firmador DSS configurado" srcset="https://fran.cr/wp-content/uploads/2016/11/Captura-de-pantalla-de-2016-11-07-14-57-51.png 650w, https://fran.cr/wp-content/uploads/2016/11/Captura-de-pantalla-de-2016-11-07-14-57-51-300x179.png 300w" sizes="(max-width: 650px) 100vw, 650px"></p>
<h2>Firmado de un documento PDF</h2>
<p>En fichero a firmar (<code>File to sign</code>) se selecciona el documento PDF que se desea firmar digitalmente.</p>
<p>En formato de firma (<code>Signature format</code>) se debe elegir PAdES porque se trata de un PDF.</p>
<p>En PAdES solamente existe el formato envuelto (<code>Enveloped</code>), por lo que este campo lo selecciona automáticamente.</p>
<p>En el nivel (<code>Level</code>) se elige el nivel de perfil de PAdES. PAdES-BASELINE-LTA es el equivalente a PAdES-LTV.</p>
<p>En algoritmo de resumen hash encriptado (<code>Digest algorithm</code>) se recomienda que sea como mínimo de tipo SHA-2, en la imagen de ejemplo se ha seleccionado SHA-512.</p>
<p>En <code>Signature token API</code> se tiene que seleccionar <code>PKCS #11</code>, entonces se desplegará <code>PKCS #11 library</code> donde hay que especificar dónde está la librería del módulo de Firma Digital (libASEP11.so).</p>
<p>En contraseña (<code>Password</code>) se ingresa el PIN de la tarjeta de Firma Digital.</p>
<p>Cuando se presione sobre <code>Sign</code> se iniciará el proceso de firmado y tras unos segundos aparecerá una ventana para guardar el PDF generado en la ubicación que se desee.</p>
<p>Eso es todo. El documento PDF ya tiene una firma válida en el país.</p>
<h2>Demostración de documento válido generado</h2>
<p>Esta imagen muestra que la firma generada es válida en la aplicación Acrobat Reader DC:</p>
<p><img class="alignnone size-medium wp-image-64" src="https://fran.cr/wp-content/uploads/2016/11/Captura-de-pantalla-de-2016-11-07-15-38-14.png" alt="Validando firma en Adobe Reader" srcset="https://fran.cr/wp-content/uploads/2016/11/Captura-de-pantalla-de-2016-11-07-15-38-14.png 1024w, https://fran.cr/wp-content/uploads/2016/11/Captura-de-pantalla-de-2016-11-07-15-38-14-300x190.png 300w, https://fran.cr/wp-content/uploads/2016/11/Captura-de-pantalla-de-2016-11-07-15-38-14-768x485.png 768w" sizes="(max-width: 1024px) 100vw, 1024px"></p>
<p>Existen formas de validar la firma del documento PDF con software libre (para no tener que usar Acrobat Reader DC como en este ejemplo), pero se explicará en próximas entradas de blog.</p>
<p>Aunque este firmador no tiene campo de estampa visible (“firma visible”), la política de documento oficial no indica que el documento requiera disponer este detalle visual en los PDF.</p></body></html>